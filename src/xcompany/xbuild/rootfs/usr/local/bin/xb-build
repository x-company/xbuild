#!/usr/bin/execlineb -P

if { xb-env }
s6-envdir /etc/xbuild/env.d/

importas -u core_packages XBUILD_CONF_CORE_PACKAGES
importas -u cleanup XBUILD_CONF_CLEANUP
importas -u harden XBUILD_CONF_HARDEN

foreground {

    if { xb-header "Prepare the Image" }
    if { xb-prepare }
}

foreground {

    if { xb-header "Configure the Image" }
    if { xb-configure }
}

foreground {

    if -n { test -z ${core_packages} }
    if { xb-header "Install user defined Packages" }
    if { xb-install ${core_packages} }
}

foreground {

    if { xb-header "Install configured Runtimes" }
    if { xb-runtime }
}

foreground {

    if { xb-header "Build configured Services" }
    if { xb-buildsvc }
}

foreground {

    if { s6-test "${cleanup}" = "Y" }
    if { xb-header "Cleanup the Image" }
    if { xb-cleanup }
}

foreground {

    if { s6-test "${harden}" = "Y" }
    if { xb-header "Harden the Image" }
    if { xb-harden }
}

if { xb-header "Image is created" }
if { xb-log "Your Image was created and secured. Have fun." }
