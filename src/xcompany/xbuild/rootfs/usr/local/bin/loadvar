#!/usr/bin/execlineb -P

define envdir /etc/xbuild/env.d
if { s6-mkdir -p ${envdir} }

if { s6-echo "[xbuild] create default environment" }
foreground { redirfd -w 1 ${envdir}/LC_ALL s6-echo -n -- "C" }
foreground { redirfd -w 1 ${envdir}/DEBIAN_FRONTEND s6-echo -n -- "noninteractive" }
foreground { redirfd -w 1 ${envdir}/SHELL s6-echo -n -- "/bin/bash" }

# Prevent initramfs updates from trying to run grub and lilo.
# https://journal.paul.querna.org/articles/2013/10/15/docker-ubuntu-on-rackspace/
# http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=594189
foreground { redirfd -w 1 ${envdir}/INITRD s6-echo -n -- "no" }

foreground { redirfd -w 1 ${envdir}/XBUILD_OS_NAME s6-echo -n -- "ubuntu" }
foreground { redirfd -w 1 ${envdir}/XBUILD_OS_CODENAME s6-echo -n -- "" }
foreground { redirfd -w 1 ${envdir}/XBUILD_OS_RELEASE s6-echo -n -- "" }

if { s6-echo "[xbuild] determine current OS" }
foreground {
    pipeline { cat /etc/os-release }
    forstdin -- line
    importas -u line line

    if { test ${line} = ID=debian }
    redirfd -w 1 ${envdir}/XBUILD_OS_NAME s6-echo -n -- "debian"
}

if { s6-echo "[xbuild] determine current OS Code Name" }
foreground {
    pipeline { cat /etc/os-release }
    forstdin -- line
    importas -u line line

    if { test (${line} =~ "VERSION=") }
    # redirfd -w 1 ${envdir}/XBUILD_OS_CODENAME s6-echo -n -- "${line}"
    s6-echo "Found"
}


s6-envdir -- /etc/xbuild/env.d

exit 0
